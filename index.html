<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ENERGY USE per £1m GVA by UK LOCAL AUTHORITY (2015-2023)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <!-- Leaflet + PapaParse (defer) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer crossorigin="anonymous"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
    :root { --bg:#0b0f19; --panel:#212F47; --text:#e8ecf3; --muted:#c3ccda; --accent:#4f8cff; --border:#2f3e5b; }
 html, body {
  height: 100%;
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* --- Header: restore style --- */
header {
  grid-column: 1 / -1;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);         /* your navy #212F47 */
  display: flex;
  align-items: center;
  gap: 12px;
}
header h1 {
  margin: 0;
  font-weight: 800;
  font-size: 22px;                  /* restore size */
  letter-spacing: .5px;
  text-transform: uppercase;        /* BIG CAPS */
  color: var(--text);               /* ensure visible on navy */
}
.brand { display: flex; align-items: center; gap: 12px; }
.brand img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,.08); object-fit: cover; }
.brand .sub { color: var(--muted); font-size: 12px; }

/* --- KPI: restore “Year” box look --- */
.kpis {
  display: grid;
  grid-template-columns: 1fr;       /* one KPI since you removed Matched */
  gap: 10px;
  margin-bottom: 8px;
}
.kpi {
  background: #0e1424;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 10px;
}
.kpi .l {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}
.kpi .v {
  font-size: 18px;                  /* bump for emphasis */
  font-weight: 700;
  color: var(--text);
}

#app {
  display: grid;
  grid-template-columns: 360px 1fr;   /* widened sidebar */
  grid-template-rows: auto 1fr;
  height: 100%;
}

/* Ensure the map container actually has height */
main { position: relative; }
#map { height: 100%; width: 100%; min-height: 400px; }

/* Sidebar */
aside {
  border-right: 1px solid var(--border);
  background: var(--panel);
  padding: 14px;
  overflow-y: auto;
  overflow-x: hidden;                 /* no horizontal scroll */
}

/* Header (unchanged from yours) */
header { grid-column: 1 / -1; padding: 10px 16px; border-bottom: 1px solid var(--border); background: var(--panel); display: flex; align-items: center; gap: 12px; }
header h1 { font-size: 22px; letter-spacing: .5px; font-weight: 800; margin: 0; text-transform: uppercase; }
.brand { display: flex; align-items: center; gap: 12px; }
.brand img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,.08); object-fit: cover; }
.brand .sub { color: var(--muted); font-size: 12px; }

/* Controls */
.group { margin-bottom: 16px; }
.group label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

input[type="range"],
input[type="number"],
button,
select {
  width: 100%;
  max-width: 100%;        /* never wider than sidebar */
  box-sizing: border-box;
  background: #0e1424;
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 14px;
}
    .legend{position:absolute;bottom:16px;right:16px;background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.2;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:1000;pointer-events:none}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border-radius:2px;border:1px solid rgba(255,255,255,.1)}
    .tooltip{background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .note{font-size:12px;color:var(--muted)}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
    .kpi{background:#0e1424;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .kpi .v{font-size:16px;font-weight:600}
    .row-inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand">
        <img src="/data/logo.png" alt="logo" />
        <div>
          <h1>NEW HORIZON ECONOMICS | ENERGY USE per £1m GVA by UK LOCAL AUTHORITY (2015-2023)</h1>
          <div class="sub">ONS LAD 2023&#160;·&#160;interactive choropleth</div>
        </div>
      </div>
    </header>

   <aside>
  <div class="group kpis">
    <div class="kpi">
      <div class="l">Year</div>
      <div class="v" id="kpi-year">—</div>
    </div>
  </div>

  <div class="group">
    <label>Year</label>
    <input id="yearRange" type="range" min="2015" max="2023" step="1" value="2023"/>
    <input id="yearInput" type="number" min="2015" max="2023" step="1" value="2023" style="margin-top:6px;"/>
  </div>


    <div class="group">
  <label>Geography</label>
  <select id="geoMode">
    <option value="ITL3" selected>LAD regions</option>
    <option value="ITL1">ITL1 regions</option>
  </select>
</div>

  <div class="group">
     <label>Metric</label>
 <select id="metricMode">
  <option value="ktoe" selected>ktoe per £1m GVA</option>
  <option value="gwh">GWh per £1m GVA</option>
</select>

</div>


  <div class="group row-inline">
    <button id="playBtn" class="primary" style="flex:1;">▶ Play year</button>
    <button id="fitBtn" class="primary" style="flex:1;">Reset map</button>
  </div>
</aside>


    <main style="position:relative;">
      <div id="map"></div>
      <div id="legend" class="legend"></div>
    </main>
  </div>

  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js" defer></script>
<script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js" defer></script>

  
<script defer>
// ================= CONFIG =================
const CSV_URL        = '/data/data.csv';                 // CODE,YEAR,ENERGY,GVA,ITL1
const ITL1_GEO_URL   = '/data/itl1_boundaries.geojson';  // ITL1 polygons (codes TLC…TLN)
const LAD_GEO_URL    = '/data/lad_2023.geojson';         // LAD polygons (LAD23CD/LAD23NM)
const ENABLE_ITL1    = true;                             // show ITL1 toggle

// GeoJSON property names
const ITL1_CODE_PROP = 'ITL121CD';
const ITL1_NAME_PROP = 'ITL121NM';
const LAD_CODE_PROP  = 'LAD23CD';
const LAD_NAME_PROP  = 'LAD23NM';

// UI defaults
let year=2023, yearBounds=[2015,2023], geo='ITL3', unit='ktoe'; // LAD (ITL3) as default
// ==========================================

// Brand palette (gold-ish)
const PALETTE     = ['#fff7e6','#ffe8b3','#ffd580','#ffc247','#ffae00','#d89000','#b37400','#8c5a00'];
const NO_DATA_FILL= '#3a4258';
const K           = PALETTE.length;
const KTOE_TO_GWH = 11.63;

// State
let map, layer, geoITL1=null, geoLAD=null;
let rows=[], CSV_KEYS=null;
let BREAKS={ ITL1:[], ITL3:[] };  // fixed breaks per geography in base unit (ktoe/£1m)

// ---------- helpers ----------
const norm = x => String(x??'').trim().toUpperCase();
function num(x){
  if (x==null) return NaN;
  const s = String(x).replace(/[\s,]+/g,'').replace(/[−–—]/g,'-');
  const v = +s; return Number.isFinite(v)? v : NaN;
}
function quantiles(values, k){
  const v = values.filter(Number.isFinite).sort((a,b)=>a-b);
  if(!v.length) return [];
  const qs=[]; for(let i=0;i<=k;i++){ const p=i/k; const idx=Math.floor(p*(v.length-1)); qs.push(v[idx]); }
  return qs;
}
function colorFor(val, breaks){
  if(!Number.isFinite(val) || !breaks.length) return NO_DATA_FILL;
  for(let i=0;i<PALETTE.length;i++){ if(val <= breaks[i+1]) return PALETTE[i]; }
  return PALETTE[PALETTE.length-1];
}
const unitLabel = (u)=> u==='gwh' ? 'GWh per £1m GVA' : 'ktoe per £1m GVA';
const applyUnit = (v,u)=> !Number.isFinite(v)? v : (u==='gwh' ? v*KTOE_TO_GWH : v);

// CSV header detection (case-insensitive)
function detectCsvKeys(sampleRow){
  const headers = Object.keys(sampleRow||{});
  const find = (...cands) => headers.find(h => cands.map(c=>c.toLowerCase()).includes(h.toLowerCase())) || null;
  return {
    code:  find('CODE'),
    year:  find('YEAR'),
    energy:find('ENERGY'),
    gva:   find('GVA'),
    itl1:  find('ITL1','ITL_1')
  };
}

// --- Reproject EPSG:27700 (OSGB36 / BNG) GeoJSON -> WGS84 ---
const EPSG27700_DEF =
  '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 ' +
  '+ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';
function firstXY(coords){
  if (!coords) return null;
  if (typeof coords[0] === 'number') return coords;
  for (const c of coords) { const v = firstXY(c); if (v) return v; }
  return null;
}
function isLikelyBNG(geo){
  try{
    const xy = firstXY(geo?.features?.[0]?.geometry?.coordinates);
    if(!xy) return false;
    const [x,y] = xy;
    return Math.abs(x) > 180 || Math.abs(y) > 90;
  }catch{return false;}
}
function reproject27700toWGS84(geo){
  if (!window.proj4) return geo;
  proj4.defs('EPSG:27700', EPSG27700_DEF);
  const fwd = (xy) => proj4('EPSG:27700','WGS84', xy);
  function rp(coords){
    if (typeof coords[0] === 'number') { const [x,y]=coords; const [lon,lat]=fwd([x,y]); return [lon,lat]; }
    return coords.map(rp);
  }
  const out = JSON.parse(JSON.stringify(geo));
  for (const f of out.features) if (f.geometry?.coordinates) f.geometry.coordinates = rp(f.geometry.coordinates);
  return out;
}

// ----------------- app bootstrap -----------------
window.addEventListener('DOMContentLoaded', async ()=>{
  map = L.map('map',{preferCanvas:true,zoomSnap:0.25,zoomDelta:0.5}).setView([54.9,-3.5],6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
              {attribution:'&copy; OpenStreetMap, &copy; CARTO'}).addTo(map);

  // Controls
  const yrR=document.getElementById('yearRange'), yrI=document.getElementById('yearInput');
  yrR.addEventListener('input',e=>{year=+e.target.value; yrI.value=year; render();});
  yrI.addEventListener('input',e=>{year=+e.target.value; yrR.value=year; render();});
  document.getElementById('metricMode').addEventListener('change', e=>{ unit=e.target.value; render(); });
  document.getElementById('fitBtn').addEventListener('click', fitUK);
  document.getElementById('playBtn').addEventListener('click', togglePlay);

  const geoSel = document.getElementById('geoMode'); // your dropdown with LAD/ITL1
  if (geoSel) {
    geoSel.value = 'ITL3'; // default to LADs
    geo = 'ITL3';
    geoSel.addEventListener('change', e=>{ geo=e.target.value; swapLayer(); render(); });
  }

  try{
    await loadAll();
    computeBreaks();     // fixed bins (in base ktoe/£1m) per geography
    swapLayer();
    fitUK();
    render();
  }catch(err){
    console.error(err);
    alert('Failed to load one or more resources — check the console.');
  }
});

// ------------------- loading ---------------------
async function loadAll(){
  // CSV
  const res = await fetch(CSV_URL, {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed');
  const text = await res.text();
  const parsed = Papa.parse(text, {header:true, dynamicTyping:false, skipEmptyLines:true});
  rows = parsed.data || [];
  if(!rows.length) throw new Error('CSV parsed with 0 rows');

  CSV_KEYS = detectCsvKeys(rows[0]);
  const missing = ['code','year','energy','gva','itl1'].filter(k=>!CSV_KEYS[k]);
  if(missing.length) throw new Error('Missing CSV columns: '+missing.join(', '));

  // normalise to clean types
  rows = rows.map(r => ({
    code:  norm(r[CSV_KEYS.code]),
    year:  +r[CSV_KEYS.year],
    energy:num(r[CSV_KEYS.energy]), // total ktoe
    gva:   num(r[CSV_KEYS.gva]),    // total (chained volume)
    itl1:  norm(r[CSV_KEYS.itl1])
  }));

  // years
  const yrs = [...new Set(rows.map(r => r.year))].filter(Number.isFinite).sort((a,b)=>a-b);
  if(yrs.length){ yearBounds=[yrs[0], yrs[yrs.length-1]]; }
  document.getElementById('yearRange').min=yearBounds[0];
  document.getElementById('yearRange').max=yearBounds[1];
  document.getElementById('yearInput').min=yearBounds[0];
  document.getElementById('yearInput').max=yearBounds[1];
  year = Math.min(Math.max(year, yearBounds[0]), yearBounds[1]);
  document.getElementById('yearRange').value=year;
  document.getElementById('yearInput').value=year;

  // GeoJSONs (auto reproject if BNG)
  const g1 = await fetch(ITL1_GEO_URL, {cache:'no-store'}); if(!g1.ok) throw new Error('ITL1 geo fetch failed');
  let rawITL1 = await g1.json();
  geoITL1 = isLikelyBNG(rawITL1) ? reproject27700toWGS84(rawITL1) : rawITL1;

  const gL = await fetch(LAD_GEO_URL, {cache:'no-store'}); if(!gL.ok) throw new Error('LAD geo fetch failed');
  let rawLAD = await gL.json();
  geoLAD = isLikelyBNG(rawLAD) ? reproject27700toWGS84(rawLAD) : rawLAD;
}

// --------------- ratios & breaks ----------------
// LAD per-year ratios: Map(LAD -> ratio_ktoe_per_million)
function ratiosLAD(y){
  const by = new Map();
  for(const r of rows){ if(r.year!==y) continue;
    const k = r.code;
    if(!by.has(k)) by.set(k, {e:0,g:0});
    const a = by.get(k);
    if(Number.isFinite(r.energy)) a.e += r.energy;
    if(Number.isFinite(r.gva))    a.g += r.gva;
  }
  const out = new Map();
  for(const [k,a] of by.entries()){
    const d = a.g||0;
    out.set(k, d ? (a.e/d) : NaN);   // ktoe per £1m
  }
  return out;
}

// ITL1 per-year ratios (aggregate child LADs): Map(ITL1 -> ratio)
function ratiosITL1(y){
  const agg = new Map();
  for(const r of rows){ if(r.year!==y) continue;
    const k = r.itl1;
    if(!agg.has(k)) agg.set(k, {e:0,g:0});
    const a = agg.get(k);
    if(Number.isFinite(r.energy)) a.e += r.energy;
    if(Number.isFinite(r.gva))    a.g += r.gva;
  }
  const out = new Map();
  for(const [k,a] of agg.entries()){
    const d = a.g||0;
    out.set(k, d ? (a.e/d) : NaN);
  }
  return out;
}

// Build fixed breaks in base unit (ktoe/£1m) per geography, across all years
function computeBreaks(){
  const years = [...new Set(rows.map(r=>r.year))].filter(Number.isFinite);
  const collect = (fn) => {
    const arr=[]; for(const y of years){ const m = fn(y); for(const v of m.values()) if(Number.isFinite(v)) arr.push(v); }
    return arr;
  };
  BREAKS.ITL3 = quantiles( collect(ratiosLAD),  K );
  BREAKS.ITL1 = quantiles( collect(ratiosITL1), K );
}

// --------------- map drawing ----------------
function baseStyle(){ return { color:'#9fb6e6', weight:1.1, fillColor:NO_DATA_FILL, fillOpacity:0.9 }; }

function bindFeature(f, l, codeProp, nameProp){
  l.on({
    mouseover:e=>{ e.target.setStyle({weight:2,color:'#fff',fillColor:e.target._currentFill,fillOpacity:1}); },
    mouseout:e=>{ e.target.setStyle({weight:1.1,color:'#9fb6e6',fillColor:e.target._currentFill,fillOpacity:0.9}); },
    click:()=> map.fitBounds(l.getBounds(), {maxZoom:9})
  });
  l._codeProp = codeProp; l._nameProp = nameProp;
}

function swapLayer(){
  if(layer) map.removeLayer(layer);
  if(geo==='ITL1' && ENABLE_ITL1){
    layer = L.geoJSON(geoITL1, { style: baseStyle, onEachFeature:(f,l)=>bindFeature(f,l,ITL1_CODE_PROP,ITL1_NAME_PROP) }).addTo(map);
  }else{ // LAD / ITL3
    layer = L.geoJSON(geoLAD, { style: baseStyle, onEachFeature:(f,l)=>bindFeature(f,l,LAD_CODE_PROP,LAD_NAME_PROP) }).addTo(map);
  }
}

function render(){
  if(!layer) return;
  document.getElementById('kpi-year').textContent = year;

  // choose source ratios + breaks (base ktoe/£1m)
  const ratios = (geo==='ITL1') ? ratiosITL1(year) : ratiosLAD(year);
  let breaks   = BREAKS[geo] || [];

  // convert breaks if user selects GWh (scale everything consistently)
  const bScaled = breaks.map(b => applyUnit(b, unit));

  let matched=0, total=0;
  layer.eachLayer(l=>{
    total++;
    const f=l.feature;
    const code = norm(f.properties[l._codeProp]);
    const name = String(f.properties[l._nameProp]||'');
    const base = ratios.get(code);                 // ktoe/£1m
    const val  = applyUnit(base, unit);            // ktoe or GWh per £1m
    const fill = colorFor(val, bScaled);
    l._currentFill = fill; l.setStyle({fillColor:fill});
    const txt = Number.isFinite(val) ? val.toFixed(3) : 'No data';
    l.bindTooltip(`<div><strong>${name}</strong><br/><span class="note">${code}</span><br/>${unitLabel(unit)}: <strong>${txt}</strong></div>`,
      {sticky:true, opacity:0.95, className:'tooltip'});
    if(Number.isFinite(val)) matched++;
  });

  updateLegend(bScaled);
  // console.log(`Render ${geo}/${unit} ${year}: matched ${matched} of ${total}`);
}

function updateLegend(breaks){
  const el=document.getElementById('legend');
  const geoLabel = geo==='ITL3' ? 'LAD' : 'Region';
  let html = `<div style="margin-bottom:6px;font-weight:700;text-transform:uppercase;">
    ${unitLabel(unit)} — ${geoLabel} (fixed scale, ${yearBounds[0]}–${yearBounds[1]})
  </div>`;
  if(!breaks.length){ html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`; el.innerHTML=html; return; }
  for(let i=0;i<PALETTE.length;i++){
    const a=breaks[i], b=breaks[i+1]; if(a==null||b==null) continue;
    html += `<div class="row"><span class="swatch" style="background:${PALETTE[i]}"></span> ${Number.isFinite(a)?a.toFixed(3):'—'} – ${Number.isFinite(b)?b.toFixed(3):'—'}</div>`;
  }
  html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
  el.innerHTML = html;
}

function fitUK(){ if(!layer) return; const tight = layer.getBounds().pad(-0.05); map.fitBounds(tight, {padding:[20,20]}); }
let timer=null;
function togglePlay(){
  const btn=document.getElementById('playBtn');
  if(timer){ clearInterval(timer); timer=null; btn.textContent='▶ Play year'; return; }
  btn.textContent='⏸ Pause';
  const [minY,maxY]=yearBounds;
  timer=setInterval(()=>{ year = (year>=maxY)?minY:(year+1); document.getElementById('yearRange').value=year; document.getElementById('yearInput').value=year; render(); }, 1200);
}
</script>
